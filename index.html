<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ”ãƒƒã‚­ãƒ³ã‚°ãƒªã‚¹ãƒˆOCR v3.1 - é…é€ãƒ©ãƒ™ãƒ«ç”Ÿæˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }
        
        .section-title {
            font-size: 1.3rem;
            color: #667eea;
            margin-bottom: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 500;
        }
        
        .input-group input[type="text"],
        .input-group input[type="date"],
        .input-group input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        #results {
            margin-top: 20px;
        }
        
        .product-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .product-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        .product-table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .product-table tr:hover {
            background: #f8f9fa;
        }
        
        .product-table input {
            width: 100%;
            padding: 6px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .label-preview {
            border: 2px solid #667eea;
            padding: 20px;
            margin: 10px 0;
            background: white;
            border-radius: 8px;
            page-break-inside: avoid;
        }
        
        .label-header {
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        
        .label-body {
            font-size: 1.1rem;
            line-height: 1.8;
        }
        
        @media print {
            body {
                background: white;
            }
            
            .container {
                box-shadow: none;
            }
            
            .header, .btn, .section:not(.label-preview) {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“¦ ãƒ”ãƒƒã‚­ãƒ³ã‚°ãƒªã‚¹ãƒˆOCR v3.1</h1>
            <p>é…é€ãƒ©ãƒ™ãƒ«è‡ªå‹•ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ  (å¼·åŒ–ç‰ˆ)</p>
        </div>
        
        <div class="content">
            <!-- ã‚¹ãƒ†ãƒƒãƒ—1: ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
            <div class="section">
                <div class="section-title">ğŸ“¸ ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ”ãƒƒã‚­ãƒ³ã‚°ãƒªã‚¹ãƒˆç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>
                <div class="input-group">
                    <label for="imageFile">ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«:</label>
                    <input type="file" id="imageFile" accept="image/*">
                </div>
                <button class="btn btn-primary" onclick="executeOCR()">
                    ğŸ” OCRå®Ÿè¡Œ
                </button>
            </div>
            
            <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>OCRå‡¦ç†ä¸­... ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„</p>
            </div>
            
            <!-- ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ç·¨é›† -->
            <div class="section" id="headerSection" style="display: none;">
                <div class="section-title">ğŸ“‹ ã‚¹ãƒ†ãƒƒãƒ—2: ç´å“æƒ…å ±ã®ç¢ºèªãƒ»ç·¨é›†</div>
                <div class="input-group">
                    <label for="deliveryDate">ç´å“æ—¥:</label>
                    <input type="date" id="deliveryDate">
                </div>
                <div class="input-group">
                    <label for="clientName">å¾—æ„å…ˆå:</label>
                    <input type="text" id="clientName" placeholder="ä¾‹: å±±æ–° éŒ¦åº—">
                </div>
                <div class="input-group">
                    <label for="orderNumber">æ³¨æ–‡ç•ªå·:</label>
                    <input type="text" id="orderNumber" placeholder="ä¾‹: 000584239">
                </div>
            </div>
            
            <!-- ã‚¹ãƒ†ãƒƒãƒ—3: å•†å“ãƒªã‚¹ãƒˆç·¨é›† -->
            <div class="section" id="productsSection" style="display: none;">
                <div class="section-title">ğŸ“¦ ã‚¹ãƒ†ãƒƒãƒ—3: å•†å“ãƒªã‚¹ãƒˆã®ç¢ºèªãƒ»ç·¨é›†</div>
                <div id="results"></div>
            </div>
            
            <!-- ã‚¹ãƒ†ãƒƒãƒ—4: ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ -->
            <div class="section" id="exportSection" style="display: none;">
                <div class="section-title">ğŸ’¾ ã‚¹ãƒ†ãƒƒãƒ—4: ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="exportToCSV()">
                        ğŸ“Š CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </button>
                    <button class="btn btn-primary" onclick="generateLabels()">
                        ğŸ·ï¸ é…é€ãƒ©ãƒ™ãƒ«ç”Ÿæˆ
                    </button>
                    <button class="btn btn-secondary" onclick="copyToClipboard()">
                        ğŸ“‹ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
                    </button>
                </div>
            </div>
            
            <!-- ãƒ©ãƒ™ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
            <div id="labelPreview"></div>
        </div>
    </div>

    <script>
        // Google Cloud Vision API Key
        const apiKey = 'AIzaSyAl2_e7KKnNcW4nQfP8Q8ODwQjfbk1WF_g';
        
        let extractedProducts = [];
        let headerInfo = {
            deliveryDate: '',
            clientName: '',
            orderNumber: ''
        };
        
        // OCRå®Ÿè¡Œ
        async function executeOCR() {
            const fileInput = document.getElementById('imageFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            document.getElementById('loading').classList.add('show');
            
            try {
                // ç”»åƒã‚’Base64ã«å¤‰æ›
                const base64Image = await fileToBase64(file);
                
                // Google Cloud Vision APIã«é€ä¿¡
                const response = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        requests: [{
                            image: { content: base64Image },
                            features: [{ type: 'TEXT_DETECTION' }]
                        }]
                    })
                });
                
                const data = await response.json();
                const text = data.responses[0].fullTextAnnotation?.text || '';
                
                console.log('=== OCRç”Ÿãƒ†ã‚­ã‚¹ãƒˆ ===');
                console.log(text);
                
                // ãƒ†ã‚­ã‚¹ãƒˆã‚’è§£æ
                parseOCRText(text);
                
                // çµæœã‚’è¡¨ç¤º
                displayResults();
                
            } catch (error) {
                alert('OCRå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                document.getElementById('loading').classList.remove('show');
            }
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Base64ã«å¤‰æ›
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        // OCRãƒ†ã‚­ã‚¹ãƒˆã‚’è§£æ (v2ã®å¼·åŒ–ãƒ­ã‚¸ãƒƒã‚¯)
        function parseOCRText(text) {
            const lines = text.split('\n');
            extractedProducts = [];
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ã‚’æŠ½å‡º
            extractHeaderInfo(lines);
            
            // å•†å“æƒ…å ±ã‚’æŠ½å‡º (v2ã®å®Œç’§ãªãƒ­ã‚¸ãƒƒã‚¯)
            extractProductsAdvanced(lines);
        }
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ã‚’æŠ½å‡º
        function extractHeaderInfo(lines) {
            // æ—¥ä»˜æŠ½å‡º
            for (let line of lines) {
                // ä»¤å’Œå½¢å¼: R2.12.20, ä»¤å’Œ2å¹´12æœˆ20æ—¥
                const reiwaMatch = line.match(/[Rr]\.?(\d+)\.(\d+)\.(\d+)|ä»¤å’Œ\s*(\d+)\s*å¹´\s*(\d+)\s*æœˆ\s*(\d+)\s*æ—¥/);
                if (reiwaMatch) {
                    const year = parseInt(reiwaMatch[1] || reiwaMatch[4]) + 2018;
                    const month = (reiwaMatch[2] || reiwaMatch[5]).padStart(2, '0');
                    const day = (reiwaMatch[3] || reiwaMatch[6]).padStart(2, '0');
                    headerInfo.deliveryDate = `${year}-${month}-${day}`;
                }
                
                // è¥¿æš¦å½¢å¼: 2024-12-20, 2024/12/20, 12/20
                const dateMatch = line.match(/(\d{4})[/-](\d{1,2})[/-](\d{1,2})|(\d{1,2})[/-](\d{1,2})/);
                if (dateMatch && !headerInfo.deliveryDate) {
                    if (dateMatch[1]) {
                        const year = dateMatch[1];
                        const month = dateMatch[2].padStart(2, '0');
                        const day = dateMatch[3].padStart(2, '0');
                        headerInfo.deliveryDate = `${year}-${month}-${day}`;
                    } else {
                        const year = new Date().getFullYear();
                        const month = dateMatch[4].padStart(2, '0');
                        const day = dateMatch[5].padStart(2, '0');
                        headerInfo.deliveryDate = `${year}-${month}-${day}`;
                    }
                }
                
                // æ³¨æ–‡ç•ªå·æŠ½å‡º (8æ¡ä»¥ä¸Šã®è‹±æ•°å­—)
                const orderMatch = line.match(/\b([A-Z0-9]{8,})\b/);
                if (orderMatch && !headerInfo.orderNumber) {
                    headerInfo.orderNumber = orderMatch[1];
                }
                
                // å¾—æ„å…ˆåæŠ½å‡º
                if (line.includes('åº—') || line.includes('æ§˜') || line.includes('ãƒªãƒ¼ãƒ–')) {
                    if (!headerInfo.clientName && line.length > 2 && line.length < 30) {
                        headerInfo.clientName = line.trim();
                    }
                }
            }
        }
        
        // å•†å“æƒ…å ±ã‚’æŠ½å‡º (v2ã®å®Œç’§ãªãƒ­ã‚¸ãƒƒã‚¯)
        function extractProductsAdvanced(lines) {
            const processedLines = new Set();
            const usedProductNames = new Set();
            
            for (let i = 0; i < lines.length; i++) {
                if (processedLines.has(i)) continue;
                
                const line = lines[i].trim();
                
                // ã‚¹ã‚­ãƒƒãƒ—æ¡ä»¶
                if (line.length < 2) continue;
                if (/^\d{11,}$/.test(line)) continue; // å•†å“ã‚³ãƒ¼ãƒ‰
                if (/^[tT]\s+\d+\.\d+$/.test(line)) continue; // å‡ºåº«ã‚³ãƒ¼ãƒ‰
                if (/^(ç´å“æ—¥|å¾—æ„å…ˆ|æ³¨æ–‡ç•ªå·|å€‰åº«|ãƒ‘ãƒ¬ãƒƒãƒˆ|Page|åˆè¨ˆ)/.test(line)) continue;
                if (/^[â—‹â—¯\s-]+$/.test(line)) continue;
                
                let productName = '';
                let quantity = '';
                let unit = '';
                let warehouse = '';
                
                // ãƒ‘ã‚¿ãƒ¼ãƒ³1: å•†å“å - æ•°é‡å˜ä½
                let match = line.match(/^(.+?)\s+-\s+(\d+)\s*(æœ¬|å€‹|æš|ç¼¶|è¢‹|ç®±|ã‚±|m|M|kg|â„“|L)?$/);
                if (match) {
                    productName = match[1].trim();
                    quantity = match[2];
                    unit = match[3] || 'å€‹';
                }
                
                // ãƒ‘ã‚¿ãƒ¼ãƒ³2: å•†å“å æ•°é‡å˜ä½ (è¡Œå†…)
                if (!match) {
                    match = line.match(/^(.+?)\s+(\d+)\s*(æœ¬|å€‹|æš|ç¼¶|è¢‹|ç®±|æ¢±|ã‚±|m|M|kg|â„“|L)$/);
                    if (match) {
                        productName = match[1].trim();
                        quantity = match[2];
                        unit = match[3];
                    }
                }
                
                // ãƒ‘ã‚¿ãƒ¼ãƒ³3: æ¢±åŒ…å˜ä½ â†’ å®Ÿæ•°é‡å¤‰æ›
                if (!match && /æ¢±/.test(line)) {
                    const konMatch = line.match(/^(.+?)\s+æ¢±\s*\((\d+)\)$/);
                    if (konMatch) {
                        productName = konMatch[1].trim();
                        const konCount = parseInt(konMatch[2]);
                        // æ¬¡ã®è¡Œã§æ•°é‡ã‚’æ¢ã™
                        for (let j = i + 1; j < Math.min(i + 3, lines.length); j++) {
                            const qtyMatch = lines[j].match(/^(\d+)$/);
                            if (qtyMatch) {
                                quantity = (parseInt(qtyMatch[1]) * konCount).toString();
                                unit = 'å€‹';
                                processedLines.add(j);
                                break;
                            }
                        }
                    }
                }
                
                // ãƒ‘ã‚¿ãƒ¼ãƒ³4: å•†å“å(æ”¹è¡Œ)æ•°é‡å˜ä½
                if (!match && i < lines.length - 1) {
                    const nextLine = lines[i + 1].trim();
                    const qtyMatch = nextLine.match(/^(\d+)\s*(æœ¬|å€‹|æš|ç¼¶|è¢‹|ç®±|æ¢±|ã‚±|m|M|kg|â„“|L)?$/);
                    if (qtyMatch && line.length > 3) {
                        // å•†å“åã‚‰ã—ã„è¡Œã‹ãƒã‚§ãƒƒã‚¯
                        if (!/^\d+$/.test(line) && !/^[A-Z]$/.test(line)) {
                            productName = line;
                            quantity = qtyMatch[1];
                            unit = qtyMatch[2] || 'å€‹';
                            processedLines.add(i + 1);
                        }
                    }
                }
                
                // ãƒ‘ã‚¿ãƒ¼ãƒ³5: æ•°å­—+ã‚¹ãƒšãƒ¼ã‚¹+å•†å“åã®è¤‡åˆè¡Œã‚’æ¤œå‡º
                if (!match) {
                    const complexMatch = line.match(/^(\d+)\s+(.+)$/);
                    if (complexMatch && complexMatch[2].length > 5) {
                        // å‰æ–¹ã®å•†å“åã‚’æ¢ã™
                        for (let backStep = 1; backStep <= 5; backStep++) {
                            if (i - backStep < 0) break;
                            const prevLine = lines[i - backStep].trim();
                            if (prevLine.length > 3 && !/^\d+$/.test(prevLine) && !processedLines.has(i - backStep)) {
                                productName = prevLine;
                                quantity = complexMatch[1];
                                // å˜ä½ã‚’æ¨æ¸¬
                                if (prevLine.includes('ç®¡') || prevLine.includes('ãƒ‘ã‚¤ãƒ—') || prevLine.includes('æ£’')) {
                                    unit = 'æœ¬';
                                } else if (prevLine.includes('æ¿')) {
                                    unit = 'æš';
                                } else {
                                    unit = 'å€‹';
                                }
                                processedLines.add(i - backStep);
                                break;
                            }
                        }
                    }
                }
                
                // å€‰åº«è¨˜å·æŠ½å‡º
                const warehouseMatch = line.match(/[å€‰åº«]?\s*([A-Z])\s*$/);
                if (warehouseMatch) {
                    warehouse = warehouseMatch[1];
                }
                
                // å•†å“ã¨ã—ã¦è¿½åŠ 
                if (productName && quantity && !usedProductNames.has(productName)) {
                    extractedProducts.push({
                        name: productName,
                        quantity: quantity,
                        unit: unit,
                        warehouse: warehouse
                    });
                    usedProductNames.add(productName);
                    processedLines.add(i);
                }
            }
            
            console.log(`æŠ½å‡ºã•ã‚ŒãŸå•†å“æ•°: ${extractedProducts.length}`);
        }
        
        // çµæœã‚’è¡¨ç¤º
        function displayResults() {
            // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º
            document.getElementById('headerSection').style.display = 'block';
            document.getElementById('deliveryDate').value = headerInfo.deliveryDate;
            document.getElementById('clientName').value = headerInfo.clientName;
            document.getElementById('orderNumber').value = headerInfo.orderNumber;
            
            // å•†å“ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
            let html = `<div class="alert alert-success">âœ… ${extractedProducts.length}ä»¶ã®å•†å“ã‚’æŠ½å‡ºã—ã¾ã—ãŸ</div>`;
            html += '<table class="product-table">';
            html += '<thead><tr>';
            html += '<th>No.</th><th>å•†å“å</th><th>æ•°é‡</th><th>å˜ä½</th><th>å€‰åº«</th>';
            html += '</tr></thead><tbody>';
            
            extractedProducts.forEach((product, index) => {
                html += '<tr>';
                html += `<td>${index + 1}</td>`;
                html += `<td><input type="text" value="${product.name}" onchange="updateProduct(${index}, 'name', this.value)"></td>`;
                html += `<td><input type="text" value="${product.quantity}" onchange="updateProduct(${index}, 'quantity', this.value)"></td>`;
                html += `<td><input type="text" value="${product.unit}" onchange="updateProduct(${index}, 'unit', this.value)"></td>`;
                html += `<td><input type="text" value="${product.warehouse}" onchange="updateProduct(${index}, 'warehouse', this.value)"></td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            
            document.getElementById('results').innerHTML = html;
            document.getElementById('productsSection').style.display = 'block';
            document.getElementById('exportSection').style.display = 'block';
        }
        
        // å•†å“æƒ…å ±ã‚’æ›´æ–°
        function updateProduct(index, field, value) {
            extractedProducts[index][field] = value;
        }
        
        // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportToCSV() {
            headerInfo.deliveryDate = document.getElementById('deliveryDate').value;
            headerInfo.clientName = document.getElementById('clientName').value;
            headerInfo.orderNumber = document.getElementById('orderNumber').value;
            
            let csv = '\uFEFF';
            csv += 'ç´å“æ—¥,å¾—æ„å…ˆ,æ³¨æ–‡ç•ªå·,No.,å•†å“å,æ•°é‡,å˜ä½,å€‰åº«\n';
            
            extractedProducts.forEach((product, index) => {
                csv += `${headerInfo.deliveryDate},`;
                csv += `${headerInfo.clientName},`;
                csv += `${headerInfo.orderNumber},`;
                csv += `${index + 1},`;
                csv += `"${product.name}",`;
                csv += `${product.quantity},`;
                csv += `${product.unit},`;
                csv += `${product.warehouse}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `picking_list_${headerInfo.orderNumber || 'export'}.csv`;
            link.click();
        }
        
        // é…é€ãƒ©ãƒ™ãƒ«ç”Ÿæˆ
        function generateLabels() {
            headerInfo.deliveryDate = document.getElementById('deliveryDate').value;
            headerInfo.clientName = document.getElementById('clientName').value;
            headerInfo.orderNumber = document.getElementById('orderNumber').value;
            
            let html = '<div class="section"><div class="section-title">ğŸ·ï¸ é…é€ãƒ©ãƒ™ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>';
            
            extractedProducts.forEach((product, index) => {
                html += '<div class="label-preview">';
                html += '<div class="label-header">';
                html += `<h3>é…é€ãƒ©ãƒ™ãƒ« #${index + 1}</h3>`;
                html += '</div>';
                html += '<div class="label-body">';
                html += `<p><strong>ç´å“æ—¥:</strong> ${headerInfo.deliveryDate}</p>`;
                html += `<p><strong>å¾—æ„å…ˆ:</strong> ${headerInfo.clientName}</p>`;
                html += `<p><strong>æ³¨æ–‡ç•ªå·:</strong> ${headerInfo.orderNumber}</p>`;
                html += '<hr style="margin: 15px 0;">';
                html += '<h4>ã€å•†å“æƒ…å ±ã€‘</h4>';
                html += `<p><strong>å“å:</strong> ${product.name}</p>`;
                html += `<p><strong>æ•°é‡:</strong> ${product.quantity} ${product.unit}</p>`;
                html += `<p><strong>å€‰åº«:</strong> ${product.warehouse}</p>`;
                html += '</div>';
                html += '</div>';
            });
            
            html += '<button class="btn btn-primary" onclick="window.print()">ğŸ–¨ï¸ å°åˆ·</button>';
            html += '</div>';
            
            document.getElementById('labelPreview').innerHTML = html;
        }
        
        // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        function copyToClipboard() {
            let text = 'ã€ãƒ”ãƒƒã‚­ãƒ³ã‚°ãƒªã‚¹ãƒˆã€‘\n\n';
            text += `ç´å“æ—¥: ${document.getElementById('deliveryDate').value}\n`;
            text += `å¾—æ„å…ˆ: ${document.getElementById('clientName').value}\n`;
            text += `æ³¨æ–‡ç•ªå·: ${document.getElementById('orderNumber').value}\n\n`;
            text += `å•†å“æ•°: ${extractedProducts.length}ä»¶\n\n`;
            
            extractedProducts.forEach((product, index) => {
                text += `${index + 1}. ${product.name} - ${product.quantity}${product.unit}`;
                if (product.warehouse) text += ` (å€‰åº«${product.warehouse})`;
                text += '\n';
            });
            
            navigator.clipboard.writeText(text).then(() => {
                alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ!');
            });
        }
    </script>
</body>
</html>
